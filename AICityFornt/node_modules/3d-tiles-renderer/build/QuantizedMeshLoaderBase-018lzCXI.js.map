{"version":3,"file":"QuantizedMeshLoaderBase-018lzCXI.js","sources":["../src/core/plugins/auth/GoogleCloudAuth.js","../src/core/plugins/auth/CesiumIonAuth.js","../src/core/plugins/loaders/QuantizedMeshLoaderBase.js"],"sourcesContent":["import { TraversalUtils } from '3d-tiles-renderer/core';\n\nconst TILES_MAP_URL = 'https://tile.googleapis.com/v1/createSession';\n\n// Class for making fetches to Google Cloud, refreshing the token if needed.\n// Supports both the 2d map tiles API in addition to 3d tiles.\nexport class GoogleCloudAuth {\n\n\tget isMapTilesSession() {\n\n\t\treturn this.authURL === TILES_MAP_URL;\n\n\t}\n\n\tconstructor( options = {} ) {\n\n\t\tconst { apiToken, sessionOptions = null, autoRefreshToken = false } = options;\n\t\tthis.apiToken = apiToken;\n\t\tthis.autoRefreshToken = autoRefreshToken;\n\t\tthis.authURL = TILES_MAP_URL;\n\t\tthis.sessionToken = null;\n\t\tthis.sessionOptions = sessionOptions;\n\t\tthis._tokenRefreshPromise = null;\n\n\t}\n\n\tasync fetch( url, options ) {\n\n\t\t// if we're using a map tiles session then we have to refresh the token separately\n\t\tif ( this.sessionToken === null && this.isMapTilesSession ) {\n\n\t\t\tthis.refreshToken( options );\n\n\t\t}\n\n\t\tawait this._tokenRefreshPromise;\n\n\t\t// construct the url\n\t\tconst fetchUrl = new URL( url );\n\t\tfetchUrl.searchParams.set( 'key', this.apiToken );\n\t\tif ( this.sessionToken ) {\n\n\t\t\tfetchUrl.searchParams.set( 'session', this.sessionToken );\n\n\t\t}\n\n\t\t// try to refresh the session token if we failed to load it\n\t\tlet res = await fetch( fetchUrl, options );\n\t\tif ( res.status >= 400 && res.status <= 499 && this.autoRefreshToken ) {\n\n\t\t\t// refresh the session token\n\t\t\tawait this.refreshToken( options );\n\t\t\tif ( this.sessionToken ) {\n\n\t\t\t\tfetchUrl.searchParams.set( 'session', this.sessionToken );\n\n\t\t\t}\n\n\t\t\tres = await fetch( fetchUrl, options );\n\n\t\t}\n\n\t\tif ( this.sessionToken === null && ! this.isMapTilesSession ) {\n\n\t\t\t// if we're using a 3d tiles session then we get the session key in the first request\n\t\t\treturn res\n\t\t\t\t.json()\n\t\t\t\t.then( json => {\n\n\t\t\t\t\tthis.sessionToken = getSessionToken( json );\n\t\t\t\t\treturn json;\n\n\t\t\t\t} );\n\n\t\t} else {\n\n\t\t\treturn res;\n\n\t\t}\n\n\t}\n\n\trefreshToken( options ) {\n\n\t\tif ( this._tokenRefreshPromise === null ) {\n\n\t\t\t// construct the url to fetch the endpoint\n\t\t\tconst url = new URL( this.authURL );\n\t\t\turl.searchParams.set( 'key', this.apiToken );\n\n\t\t\t// initialize options for map tiles\n\t\t\tconst fetchOptions = { ...options };\n\t\t\tif ( this.isMapTilesSession ) {\n\n\t\t\t\tfetchOptions.method = 'POST';\n\t\t\t\tfetchOptions.body = JSON.stringify( this.sessionOptions );\n\t\t\t\tfetchOptions.headers = fetchOptions.headers || {};\n\t\t\t\tfetchOptions.headers = {\n\t\t\t\t\t...fetchOptions.headers,\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t};\n\n\t\t\t}\n\n\t\t\tthis._tokenRefreshPromise = fetch( url, fetchOptions )\n\t\t\t\t.then( res => {\n\n\t\t\t\t\tif ( ! res.ok ) {\n\n\t\t\t\t\t\tthrow new Error( `GoogleCloudAuth: Failed to load data with error code ${ res.status }` );\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn res.json();\n\n\t\t\t\t} )\n\t\t\t\t.then( json => {\n\n\t\t\t\t\tthis.sessionToken = getSessionToken( json );\n\t\t\t\t\tthis._tokenRefreshPromise = null;\n\n\t\t\t\t\treturn json;\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\treturn this._tokenRefreshPromise;\n\n\t}\n\n}\n\n// Takes a json response from the auth url and extracts the session token\nfunction getSessionToken( json ) {\n\n\tif ( 'session' in json ) {\n\n\t\t// if using the 2d maps api\n\t\treturn json.session;\n\n\t} else {\n\n\t\t// is using the 3d tiles api\n\t\tlet sessionToken = null;\n\t\tconst root = json.root;\n\t\tTraversalUtils.traverseSet( root, tile => {\n\n\t\t\tif ( tile.content && tile.content.uri ) {\n\n\t\t\t\tconst [ , params ] = tile.content.uri.split( '?' );\n\t\t\t\tsessionToken = new URLSearchParams( params ).get( 'session' );\n\t\t\t\treturn true;\n\n\t\t\t}\n\n\t\t\treturn false;\n\n\t\t} );\n\n\t\treturn sessionToken;\n\n\t}\n\n}\n\n","// Class for making fetches to Cesium Ion, refreshing the token if needed.\nexport class CesiumIonAuth {\n\n\tconstructor( options = {} ) {\n\n\t\tconst { apiToken, autoRefreshToken = false } = options;\n\t\tthis.apiToken = apiToken;\n\t\tthis.autoRefreshToken = autoRefreshToken;\n\t\tthis.authURL = null;\n\t\tthis._tokenRefreshPromise = null;\n\t\tthis._bearerToken = null;\n\n\t}\n\n\tasync fetch( url, options ) {\n\n\t\tawait this._tokenRefreshPromise;\n\n\t\t// insert the authorization token\n\t\tconst fetchOptions = { ...options };\n\t\tfetchOptions.headers = fetchOptions.headers || {};\n\t\tfetchOptions.headers = {\n\t\t\t...fetchOptions.headers,\n\t\t\tAuthorization: this._bearerToken,\n\t\t};\n\n\t\t// try to refresh the token if we failed to load the tile data\n\t\tconst res = await fetch( url, fetchOptions );\n\t\tif ( res.status >= 400 && res.status <= 499 && this.autoRefreshToken ) {\n\n\t\t\t// refresh the bearer token\n\t\t\tawait this.refreshToken( options );\n\t\t\tfetchOptions.headers.Authorization = this._bearerToken;\n\n\t\t\treturn fetch( url, fetchOptions );\n\n\t\t} else {\n\n\t\t\treturn res;\n\n\t\t}\n\n\t}\n\n\trefreshToken( options ) {\n\n\t\tif ( this._tokenRefreshPromise === null ) {\n\n\t\t\t// construct the url to fetch the endpoint\n\t\t\tconst url = new URL( this.authURL );\n\t\t\turl.searchParams.set( 'access_token', this.apiToken );\n\n\t\t\tthis._tokenRefreshPromise = fetch( url, options )\n\t\t\t\t.then( res => {\n\n\t\t\t\t\tif ( ! res.ok ) {\n\n\t\t\t\t\t\tthrow new Error( `CesiumIonAuthPlugin: Failed to load data with error code ${ res.status }` );\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn res.json();\n\n\t\t\t\t} )\n\t\t\t\t.then( json => {\n\n\t\t\t\t\tthis._bearerToken = `Bearer ${ json.accessToken }`;\n\t\t\t\t\tthis._tokenRefreshPromise = null;\n\n\t\t\t\t\treturn json;\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\treturn this._tokenRefreshPromise;\n\n\t}\n\n}\n","import { LoaderBase } from '3d-tiles-renderer/core';\n\nexport function zigZagDecode( value ) {\n\n\treturn ( value >> 1 ) ^ ( - ( value & 1 ) );\n\n}\n\nexport class QuantizedMeshLoaderBase extends LoaderBase {\n\n\tconstructor( ...args ) {\n\n\t\tsuper( ...args );\n\n\t\tthis.fetchOptions.header = {\n\t\t\tAccept: 'application/vnd.quantized-mesh,application/octet-stream;q=0.9',\n\t\t};\n\n\t}\n\n\tloadAsync( ...args ) {\n\n\t\tconst { fetchOptions } = this;\n\t\tfetchOptions.header = fetchOptions.header || {};\n\t\tfetchOptions.header[ 'Accept' ] = 'application/vnd.quantized-mesh,application/octet-stream;q=0.9';\n\t\tfetchOptions.header[ 'Accept' ] += ';extensions=octvertexnormals-watermask-metadata';\n\n\t\treturn super.loadAsync( ...args );\n\n\t}\n\n\tparse( buffer ) {\n\n\t\tlet pointer = 0;\n\t\tconst view = new DataView( buffer );\n\t\tconst readFloat64 = () => {\n\n\t\t\tconst result = view.getFloat64( pointer, true );\n\t\t\tpointer += 8;\n\t\t\treturn result;\n\n\t\t};\n\n\t\tconst readFloat32 = () => {\n\n\t\t\tconst result = view.getFloat32( pointer, true );\n\t\t\tpointer += 4;\n\t\t\treturn result;\n\n\t\t};\n\n\t\tconst readInt = () => {\n\n\t\t\tconst result = view.getUint32( pointer, true );\n\t\t\tpointer += 4;\n\t\t\treturn result;\n\n\t\t};\n\n\t\tconst readByte = () => {\n\n\t\t\tconst result = view.getUint8( pointer );\n\t\t\tpointer += 1;\n\t\t\treturn result;\n\n\t\t};\n\n\t\tconst readBuffer = ( count, type ) => {\n\n\t\t\tconst result = new type( buffer, pointer, count );\n\t\t\tpointer += count * type.BYTES_PER_ELEMENT;\n\t\t\treturn result;\n\n\t\t};\n\n\t\t// extract header\n\t\tconst header = {\n\t\t\tcenter: [ readFloat64(), readFloat64(), readFloat64() ],\n\t\t\tminHeight: readFloat32(),\n\t\t\tmaxHeight: readFloat32(),\n\t\t\tsphereCenter: [ readFloat64(), readFloat64(), readFloat64() ],\n\t\t\tsphereRadius: readFloat64(),\n\t\t\thorizonOcclusionPoint: [ readFloat64(), readFloat64(), readFloat64() ],\n\t\t};\n\n\t\t// extract vertex data\n\t\tconst vertexCount = readInt();\n\t\tconst uBuffer = readBuffer( vertexCount, Uint16Array );\n\t\tconst vBuffer = readBuffer( vertexCount, Uint16Array );\n\t\tconst hBuffer = readBuffer( vertexCount, Uint16Array );\n\n\t\tconst uResult = new Float32Array( vertexCount );\n\t\tconst vResult = new Float32Array( vertexCount );\n\t\tconst hResult = new Float32Array( vertexCount );\n\n\t\t// decode vertex data\n\t\tlet u = 0;\n\t\tlet v = 0;\n\t\tlet h = 0;\n\t\tconst MAX_VALUE = 32767;\n\t\tfor ( let i = 0; i < vertexCount; ++ i ) {\n\n\t\t\tu += zigZagDecode( uBuffer[ i ] );\n\t\t\tv += zigZagDecode( vBuffer[ i ] );\n\t\t\th += zigZagDecode( hBuffer[ i ] );\n\n\t\t\tuResult[ i ] = u / MAX_VALUE;\n\t\t\tvResult[ i ] = v / MAX_VALUE;\n\t\t\thResult[ i ] = h / MAX_VALUE;\n\n\t\t}\n\n\t\t// align pointer for index data\n\t\tconst is32 = vertexCount > 65536;\n\t\tconst bufferType = is32 ? Uint32Array : Uint16Array;\n\t\tif ( is32 ) {\n\n\t\t\tpointer = Math.ceil( pointer / 4 ) * 4;\n\n\t\t} else {\n\n\t\t\tpointer = Math.ceil( pointer / 2 ) * 2;\n\n\t\t}\n\n\t\t// extract index data\n\t\tconst triangleCount = readInt();\n\t\tconst indices = readBuffer( triangleCount * 3, bufferType );\n\n\t\t// decode the index data\n\t\tlet highest = 0;\n\t\tfor ( var i = 0; i < indices.length; ++ i ) {\n\n\t\t\tconst code = indices[ i ];\n\t\t\tindices[ i ] = highest - code;\n\t\t\tif ( code === 0 ) {\n\n\t\t\t\t++ highest;\n\n\t\t\t}\n\n\t\t}\n\n\t\t// sort functions for the edges since they are not pre-sorted\n\t\tconst vSort = ( a, b ) => vResult[ b ] - vResult[ a ];\n\t\tconst vSortReverse = ( a, b ) => - vSort( a, b );\n\n\t\tconst uSort = ( a, b ) => uResult[ a ] - uResult[ b ];\n\t\tconst uSortReverse = ( a, b ) => - uSort( a, b );\n\n\t\t// get edge indices\n\t\tconst westVertexCount = readInt();\n\t\tconst westIndices = readBuffer( westVertexCount, bufferType );\n\t\twestIndices.sort( vSort );\n\n\t\tconst southVertexCount = readInt();\n\t\tconst southIndices = readBuffer( southVertexCount, bufferType );\n\t\tsouthIndices.sort( uSort );\n\n\t\tconst eastVertexCount = readInt();\n\t\tconst eastIndices = readBuffer( eastVertexCount, bufferType );\n\t\teastIndices.sort( vSortReverse );\n\n\t\tconst northVertexCount = readInt();\n\t\tconst northIndices = readBuffer( northVertexCount, bufferType );\n\t\tnorthIndices.sort( uSortReverse );\n\n\t\tconst edgeIndices = {\n\t\t\twestIndices,\n\t\t\tsouthIndices,\n\t\t\teastIndices,\n\t\t\tnorthIndices,\n\t\t};\n\n\t\t// parse extensions\n\t\tconst extensions = {};\n\t\twhile ( pointer < view.byteLength ) {\n\n\t\t\tconst extensionId = readByte();\n\t\t\tconst extensionLength = readInt();\n\n\t\t\tif ( extensionId === 1 ) {\n\n\t\t\t\t// oct encoded normals\n\t\t\t\tconst xy = readBuffer( vertexCount * 2, Uint8Array );\n\t\t\t\tconst normals = new Float32Array( vertexCount * 3 );\n\n\t\t\t\t// https://github.com/CesiumGS/cesium/blob/baaabaa49058067c855ad050be73a9cdfe9b6ac7/packages/engine/Source/Core/AttributeCompression.js#L119-L140\n\t\t\t\tfor ( let i = 0; i < vertexCount; i ++ ) {\n\n\t\t\t\t\tlet x = ( xy[ 2 * i + 0 ] / 255 ) * 2 - 1;\n\t\t\t\t\tlet y = ( xy[ 2 * i + 1 ] / 255 ) * 2 - 1;\n\t\t\t\t\tconst z = 1.0 - ( Math.abs( x ) + Math.abs( y ) );\n\n\t\t\t\t\tif ( z < 0.0 ) {\n\n\t\t\t\t\t\tconst oldVX = x;\n\t\t\t\t\t\tx = ( 1.0 - Math.abs( y ) ) * signNotZero( oldVX );\n\t\t\t\t\t\ty = ( 1.0 - Math.abs( oldVX ) ) * signNotZero( y );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tconst len = Math.sqrt( x * x + y * y + z * z );\n\t\t\t\t\tnormals[ 3 * i + 0 ] = x / len;\n\t\t\t\t\tnormals[ 3 * i + 1 ] = y / len;\n\t\t\t\t\tnormals[ 3 * i + 2 ] = z / len;\n\n\t\t\t\t}\n\n\t\t\t\textensions[ 'octvertexnormals' ] = {\n\t\t\t\t\textensionId,\n\t\t\t\t\tnormals,\n\t\t\t\t};\n\n\t\t\t} else if ( extensionId === 2 ) {\n\n\t\t\t\t// water mask\n\t\t\t\tconst size = extensionLength === 1 ? 1 : 256;\n\t\t\t\tconst mask = readBuffer( size * size, Uint8Array );\n\t\t\t\textensions[ 'watermask' ] = {\n\t\t\t\t\textensionId,\n\t\t\t\t\tmask,\n\t\t\t\t\tsize,\n\t\t\t\t};\n\n\t\t\t} else if ( extensionId === 4 ) {\n\n\t\t\t\t// metadata\n\t\t\t\tconst jsonLength = readInt();\n\t\t\t\tconst jsonBuffer = readBuffer( jsonLength, Uint8Array );\n\t\t\t\tconst json = new TextDecoder().decode( jsonBuffer );\n\t\t\t\textensions[ 'metadata' ] = {\n\t\t\t\t\textensionId,\n\t\t\t\t\tjson: JSON.parse( json ),\n\t\t\t\t};\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn {\n\t\t\theader,\n\t\t\tindices,\n\t\t\tvertexData: {\n\t\t\t\tu: uResult,\n\t\t\t\tv: vResult,\n\t\t\t\theight: hResult,\n\t\t\t},\n\t\t\tedgeIndices,\n\t\t\textensions,\n\t\t};\n\n\t}\n\n}\n\nfunction signNotZero( v ) {\n\n\treturn v < 0.0 ? - 1.0 : 1.0;\n\n}\n"],"names":["TILES_MAP_URL","GoogleCloudAuth","options","apiToken","sessionOptions","autoRefreshToken","url","fetchUrl","res","json","getSessionToken","fetchOptions","sessionToken","root","TraversalUtils.traverseSet","tile","params","CesiumIonAuth","zigZagDecode","value","QuantizedMeshLoaderBase","LoaderBase","args","buffer","pointer","view","readFloat64","result","readFloat32","readInt","readByte","readBuffer","count","type","header","vertexCount","uBuffer","vBuffer","hBuffer","uResult","vResult","hResult","u","h","MAX_VALUE","i","is32","bufferType","triangleCount","indices","highest","code","vSort","a","b","vSortReverse","uSort","uSortReverse","westVertexCount","westIndices","southVertexCount","southIndices","eastVertexCount","eastIndices","northVertexCount","northIndices","edgeIndices","extensions","extensionId","extensionLength","xy","normals","x","y","z","oldVX","signNotZero","len","size","mask","jsonLength","jsonBuffer","v"],"mappings":"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"}