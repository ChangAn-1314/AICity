{
  "id": "snapshot_1765705542254_ovaw0aw97",
  "approvalId": "approval_1765705542189_owg0vvuhv",
  "approvalTitle": "Backend API Tasks - 后端任务列表",
  "version": 1,
  "timestamp": "2025-12-14T09:45:42.254Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document - Backend API\r\n\r\n## Phase 1: 项目初始化与基础框架\r\n\r\n- [ ] 1.1 初始化 FastAPI 项目结构\r\n  - Files: `AICityBack/app/main.py`, `AICityBack/pyproject.toml`, `AICityBack/requirements.txt`\r\n  - 创建 FastAPI 应用入口，配置 CORS、异常处理中间件\r\n  - 配置 pyproject.toml 和 requirements.txt 依赖\r\n  - Purpose: 建立后端项目基础结构\r\n  - _Leverage: structure.md 中定义的目录结构_\r\n  - _Requirements: REQ-1, REQ-7_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Backend Developer specializing in FastAPI | Task: Initialize FastAPI project with proper structure following structure.md, create main.py with CORS, exception handlers, and basic health check endpoint | Restrictions: Follow existing directory structure, use async patterns, do not hardcode configurations | _Leverage: .spec-workflow/steering/structure.md, .spec-workflow/steering/tech.md | Success: FastAPI app starts successfully, /health endpoint returns 200, CORS configured for frontend origin | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 1.2 配置环境变量和核心设置\r\n  - Files: `AICityBack/app/core/config.py`, `AICityBack/.env.example`\r\n  - 使用 pydantic-settings 管理环境配置\r\n  - 定义数据库、Redis、讯飞 API 等配置项\r\n  - Purpose: 集中管理应用配置\r\n  - _Leverage: tech.md 中的技术选型_\r\n  - _Requirements: REQ-1_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: DevOps Engineer with Python expertise | Task: Create configuration management using pydantic-settings with all required environment variables for database, Redis, XunFei APIs, JWT secrets | Restrictions: Never commit real secrets, use .env.example as template, validate all configs on startup | _Leverage: .spec-workflow/steering/tech.md | Success: App loads configs from .env, validation errors on missing required vars, .env.example documents all vars | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 1.3 设置数据库连接和 SQLAlchemy 配置\r\n  - Files: `AICityBack/app/db/session.py`, `AICityBack/app/db/base.py`\r\n  - 配置 asyncpg + SQLAlchemy 2.0 异步连接\r\n  - 创建数据库会话依赖注入\r\n  - Purpose: 建立数据库访问层基础\r\n  - _Leverage: tech.md 中的 PostgreSQL + asyncpg_\r\n  - _Requirements: REQ-2_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Database Engineer with SQLAlchemy expertise | Task: Configure async SQLAlchemy 2.0 with asyncpg driver, create session factory and dependency injection for FastAPI | Restrictions: Use async session only, implement proper connection pooling, handle connection lifecycle correctly | _Leverage: app/core/config.py | Success: Database connects successfully, sessions are properly managed and closed, dependency injection works in routes | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 1.4 配置 Alembic 数据库迁移\r\n  - Files: `AICityBack/alembic.ini`, `AICityBack/alembic/env.py`\r\n  - 初始化 Alembic 并配置异步支持\r\n  - Purpose: 支持数据库模式版本控制\r\n  - _Leverage: app/db/session.py_\r\n  - _Requirements: REQ-2_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Database Administrator with migration expertise | Task: Initialize Alembic with async SQLAlchemy support, configure env.py for async migrations | Restrictions: Support both online and offline migrations, auto-generate from models | _Leverage: app/db/session.py, app/db/base.py | Success: alembic revision --autogenerate works, alembic upgrade head applies migrations | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 2: 数据模型与认证系统\r\n\r\n- [ ] 2.1 创建用户数据模型\r\n  - Files: `AICityBack/app/models/user.py`, `AICityBack/app/models/__init__.py`\r\n  - 定义 User SQLAlchemy 模型\r\n  - 包含 id, username, email, hashed_password, role, is_active 字段\r\n  - Purpose: 用户数据持久化\r\n  - _Leverage: design.md 中的 User Model 定义_\r\n  - _Requirements: REQ-1_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with ORM expertise | Task: Create User SQLAlchemy model following design.md specification with proper indexes and constraints | Restrictions: Use async-compatible model patterns, add created_at/updated_at timestamps | _Leverage: design.md User Model section | Success: Model creates table correctly, migrations generate successfully | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 2.2 创建认证 Pydantic Schemas\r\n  - Files: `AICityBack/app/schemas/auth.py`, `AICityBack/app/schemas/__init__.py`\r\n  - 定义 LoginRequest, TokenResponse, UserResponse 等 Schema\r\n  - Purpose: API 请求/响应数据验证\r\n  - _Leverage: Pydantic v2 patterns_\r\n  - _Requirements: REQ-1_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer with Pydantic expertise | Task: Create authentication Pydantic schemas for login request, token response, user response with proper validation | Restrictions: Use Pydantic v2 syntax, add field descriptions for OpenAPI docs | _Leverage: design.md Authentication Service section | Success: Schemas validate correctly, OpenAPI docs show proper descriptions | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 2.3 实现 JWT 安全模块\r\n  - Files: `AICityBack/app/core/security.py`\r\n  - 实现 JWT token 创建、验证、刷新\r\n  - 密码哈希 (bcrypt) 和验证\r\n  - Purpose: 提供认证安全基础设施\r\n  - _Leverage: python-jose, passlib_\r\n  - _Requirements: REQ-1_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security Engineer with JWT expertise | Task: Implement JWT token creation/verification with access and refresh tokens, password hashing using bcrypt | Restrictions: Use secure defaults, configurable expiration times, never log tokens | _Leverage: app/core/config.py for secrets | Success: Tokens generate and verify correctly, passwords hash and verify, refresh flow works | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 2.4 实现认证服务层\r\n  - Files: `AICityBack/app/services/auth_service.py`\r\n  - 实现 authenticate, verify_token, refresh_token 方法\r\n  - Purpose: 封装认证业务逻辑\r\n  - _Leverage: app/core/security.py, app/models/user.py_\r\n  - _Requirements: REQ-1_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with authentication expertise | Task: Implement AuthService with authenticate, verify_token, refresh_token, get_current_user methods | Restrictions: Async methods only, proper error handling, don't expose internal errors | _Leverage: app/core/security.py, app/models/user.py | Success: Login returns tokens, token verification works, refresh generates new access token | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 2.5 创建认证 API 路由\r\n  - Files: `AICityBack/app/api/v1/auth.py`, `AICityBack/app/api/deps.py`\r\n  - 实现 POST /login, POST /refresh, GET /me 端点\r\n  - 创建 get_current_user 依赖注入\r\n  - Purpose: 暴露认证 API 端点\r\n  - _Leverage: app/services/auth_service.py_\r\n  - _Requirements: REQ-1_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer with FastAPI expertise | Task: Create auth API routes for login, token refresh, and get current user with proper dependency injection | Restrictions: Follow RESTful conventions, use OAuth2PasswordBearer, document all endpoints | _Leverage: app/services/auth_service.py, app/schemas/auth.py | Success: /api/v1/auth/login returns tokens, /api/v1/auth/me returns user info with valid token | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 3: 舆情数据管理\r\n\r\n- [ ] 3.1 创建舆情数据模型\r\n  - Files: `AICityBack/app/models/sentiment.py`, `AICityBack/app/models/hotspot.py`\r\n  - 定义 Hotspot, AnalysisResult SQLAlchemy 模型\r\n  - Purpose: 舆情数据持久化\r\n  - _Leverage: design.md 中的数据模型定义_\r\n  - _Requirements: REQ-2_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Database Developer with SQLAlchemy expertise | Task: Create Hotspot and AnalysisResult models following design.md with proper relationships, indexes, and JSON fields | Restrictions: Use PostgreSQL JSON type for arrays, add proper indexes for query performance | _Leverage: design.md Data Models section | Success: Models migrate correctly, relationships work, JSON fields store/retrieve properly | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 3.2 创建舆情 Pydantic Schemas\r\n  - Files: `AICityBack/app/schemas/sentiment.py`\r\n  - 定义 HotspotCreate, HotspotUpdate, HotspotResponse, HotspotFilter 等\r\n  - Purpose: 舆情 API 数据验证\r\n  - _Leverage: Pydantic v2_\r\n  - _Requirements: REQ-2_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer with Pydantic expertise | Task: Create Pydantic schemas for Hotspot CRUD operations with filtering, pagination support | Restrictions: Use Pydantic v2, add validators for coordinates, enum for sentiment values | _Leverage: design.md Hotspot Model | Success: Schemas validate all fields correctly, enums restrict values, coordinates validate format | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 3.3 实现舆情服务层\r\n  - Files: `AICityBack/app/services/sentiment_service.py`\r\n  - 实现 CRUD 操作、统计查询、筛选过滤\r\n  - Purpose: 封装舆情业务逻辑\r\n  - _Leverage: app/models/sentiment.py, app/db/session.py_\r\n  - _Requirements: REQ-2_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with service layer expertise | Task: Implement SentimentService with CRUD methods, filtering, pagination, and statistics queries | Restrictions: Async methods, use SQLAlchemy select for queries, soft delete support | _Leverage: app/models/sentiment.py, design.md Sentiment Service | Success: All CRUD operations work, filters apply correctly, pagination returns proper results | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 3.4 创建舆情 API 路由\r\n  - Files: `AICityBack/app/api/v1/sentiment.py`\r\n  - 实现 GET/POST/PUT/DELETE /hotspots 端点\r\n  - 实现 GET /hotspots/statistics 端点\r\n  - Purpose: 暴露舆情管理 API\r\n  - _Leverage: app/services/sentiment_service.py_\r\n  - _Requirements: REQ-2_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer with FastAPI expertise | Task: Create sentiment API routes for CRUD operations with filtering, pagination, and statistics endpoint | Restrictions: Require authentication, use dependency injection, proper HTTP status codes | _Leverage: app/services/sentiment_service.py, app/api/deps.py | Success: All CRUD endpoints work, filters and pagination functional, statistics returns aggregated data | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 4: WebSocket 实时通信\r\n\r\n- [ ] 4.1 配置 Socket.IO 服务器\r\n  - Files: `AICityBack/app/websocket/__init__.py`, `AICityBack/app/websocket/manager.py`\r\n  - 集成 python-socketio 到 FastAPI\r\n  - 实现连接管理器\r\n  - Purpose: 建立 WebSocket 基础设施\r\n  - _Leverage: python-socketio AsyncServer_\r\n  - _Requirements: REQ-7_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with WebSocket expertise | Task: Configure python-socketio AsyncServer with FastAPI, create WebSocketManager for connection tracking | Restrictions: Use ASGI mode, configure CORS for frontend, implement heartbeat | _Leverage: app/main.py | Success: WebSocket connects from frontend, connection manager tracks active connections | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 4.2 实现 WebSocket 事件处理\r\n  - Files: `AICityBack/app/websocket/events.py`\r\n  - 实现 connect, disconnect, join_room, leave_room 事件\r\n  - 实现 emit 和 broadcast 方法\r\n  - Purpose: 处理客户端事件和消息推送\r\n  - _Leverage: app/websocket/manager.py_\r\n  - _Requirements: REQ-7_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Real-time Systems Developer | Task: Implement Socket.IO event handlers for connect/disconnect, room management, and message broadcasting | Restrictions: Handle disconnection gracefully, clean up room subscriptions, log events | _Leverage: app/websocket/manager.py | Success: Clients can join/leave rooms, messages broadcast to room members, disconnection cleans up | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 4.3 集成 WebSocket 推送到服务层\r\n  - Files: `AICityBack/app/services/notification_service.py`\r\n  - 创建通知服务，在舆情更新时触发 WebSocket 推送\r\n  - Purpose: 业务事件驱动实时通知\r\n  - _Leverage: app/websocket/manager.py, app/services/sentiment_service.py_\r\n  - _Requirements: REQ-7_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with event-driven architecture expertise | Task: Create NotificationService to emit WebSocket events on hotspot create/update, heat changes, alerts | Restrictions: Async emit, don't block main operations, include event type and payload | _Leverage: app/websocket/manager.py, design.md WebSocket events | Success: Creating hotspot emits new_sentiment event, heat change emits heat_change event | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 5: 讯飞 AI 服务集成\r\n\r\n- [ ] 5.1 实现讯飞星火客户端\r\n  - Files: `AICityBack/ai/spark/__init__.py`, `AICityBack/ai/spark/client.py`, `AICityBack/ai/spark/config.py`\r\n  - 封装讯飞星火 4.0 API 调用 (WebSocket)\r\n  - 支持普通对话和流式输出\r\n  - Purpose: 提供 AI 大模型访问能力\r\n  - _Leverage: 讯飞星火 WebSocket API_\r\n  - _Requirements: REQ-3_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: AI Integration Developer | Task: Create SparkClient with WebSocket-based chat and streaming methods for XunFei Spark 4.0 API | Restrictions: Handle auth signature correctly, implement reconnection, async generator for streaming | _Leverage: XunFei Spark API documentation, app/core/config.py | Success: Chat returns response, streaming yields chunks, handles API errors gracefully | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 5.2 创建舆情分析 Prompt 模板\r\n  - Files: `AICityBack/ai/spark/prompts.py`\r\n  - 定义情感分析、关键词提取、摘要生成的 Prompt\r\n  - Purpose: 标准化 AI 分析请求\r\n  - _Leverage: ai/spark/client.py_\r\n  - _Requirements: REQ-3_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Prompt Engineer | Task: Create prompt templates for sentiment analysis, keyword extraction, summary generation optimized for Chinese content | Restrictions: Use structured output format (JSON), include examples, handle edge cases | _Leverage: ai/spark/client.py | Success: Prompts generate consistent structured outputs, handle various content types | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 5.3 实现 AI 分析服务\r\n  - Files: `AICityBack/app/services/ai_service.py`\r\n  - 实现 analyze_sentiment, extract_keywords, generate_summary 方法\r\n  - Purpose: 封装 AI 分析业务逻辑\r\n  - _Leverage: ai/spark/client.py, ai/spark/prompts.py_\r\n  - _Requirements: REQ-3_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: AI Application Developer | Task: Implement AIService with sentiment analysis, keyword extraction, summary generation using SparkClient | Restrictions: Parse AI responses properly, handle failures gracefully, cache repeated requests | _Leverage: ai/spark/client.py, ai/spark/prompts.py | Success: Analysis returns structured results, handles API failures, caches improve performance | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 5.4 创建 AI 分析 API 路由\r\n  - Files: `AICityBack/app/api/v1/analysis.py`\r\n  - 实现 POST /analyze 端点\r\n  - 支持同步分析和异步批量分析\r\n  - Purpose: 暴露 AI 分析 API\r\n  - _Leverage: app/services/ai_service.py_\r\n  - _Requirements: REQ-3_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer | Task: Create analysis API routes for single and batch sentiment analysis with async task support | Restrictions: Require authentication, validate input content, return task ID for batch operations | _Leverage: app/services/ai_service.py | Success: Single analysis returns results, batch returns task ID, results stored in database | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 6: LangGraph 决策模拟\r\n\r\n- [ ] 6.1 定义 Agent 状态和节点\r\n  - Files: `AICityBack/agents/__init__.py`, `AICityBack/agents/state.py`, `AICityBack/agents/nodes/`\r\n  - 定义 SentimentState TypedDict\r\n  - 实现 analyze, predict, decide, simulate 节点函数\r\n  - Purpose: 构建多 Agent 决策图节点\r\n  - _Leverage: LangGraph, ai/spark/client.py_\r\n  - _Requirements: REQ-4_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: AI Agent Developer with LangGraph expertise | Task: Create SentimentState and implement analyze, predict, decide, simulate agent nodes using SparkClient | Restrictions: Each node has single responsibility, state immutability, proper error handling | _Leverage: design.md Decision Service, ai/spark/client.py | Success: Each node processes state correctly, outputs proper format for next node | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 6.2 构建 LangGraph 状态图\r\n  - Files: `AICityBack/agents/graph.py`\r\n  - 创建 StateGraph，连接节点，编译执行图\r\n  - Purpose: 编排多 Agent 决策流程\r\n  - _Leverage: agents/nodes/, LangGraph StateGraph_\r\n  - _Requirements: REQ-4_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: AI Workflow Engineer | Task: Create LangGraph StateGraph connecting analyze->predict->decide->simulate nodes with proper edges | Restrictions: Handle conditional edges, implement graph compilation, support async execution | _Leverage: agents/nodes/, design.md Decision Service architecture | Success: Graph compiles, executes full pipeline, outputs simulation results | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 6.3 实现决策模拟服务\r\n  - Files: `AICityBack/app/services/decision_service.py`\r\n  - 封装 LangGraph 调用，提供预测和模拟接口\r\n  - Purpose: 封装决策模拟业务逻辑\r\n  - _Leverage: agents/graph.py_\r\n  - _Requirements: REQ-4_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Implement DecisionService with predict_trend, simulate_decision, custom_simulate methods using LangGraph | Restrictions: Async execution, proper result parsing, store results in database | _Leverage: agents/graph.py, app/models/analysis.py | Success: Prediction returns trend data, simulation returns multi-scenario results | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 6.4 创建决策模拟 API 路由\r\n  - Files: `AICityBack/app/api/v1/decision.py`\r\n  - 实现 POST /predict, POST /simulate 端点\r\n  - Purpose: 暴露决策模拟 API\r\n  - _Leverage: app/services/decision_service.py_\r\n  - _Requirements: REQ-4_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer | Task: Create decision API routes for trend prediction and decision simulation with parameter validation | Restrictions: Require authentication, validate prediction hours (24/48/72), document response formats | _Leverage: app/services/decision_service.py | Success: Prediction returns forecast, simulation returns scenarios with probabilities | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 7: 语音和 3D 服务\r\n\r\n- [ ] 7.1 实现讯飞 TTS 客户端\r\n  - Files: `AICityBack/ai/voice/__init__.py`, `AICityBack/ai/voice/tts.py`\r\n  - 封装讯飞在线 TTS WebSocket API\r\n  - 支持流式音频输出\r\n  - Purpose: 提供语音合成能力\r\n  - _Leverage: 讯飞 TTS WebSocket API_\r\n  - _Requirements: REQ-6_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Audio/Speech Developer | Task: Create TTSClient with streaming WebSocket connection to XunFei TTS API, support multiple voices | Restrictions: Handle audio chunks properly, implement reconnection, yield audio as async generator | _Leverage: XunFei TTS API docs, app/core/config.py | Success: Text converts to audio stream, multiple voices work, handles long text | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 7.2 实现讯飞 ASR 客户端\r\n  - Files: `AICityBack/ai/voice/asr.py`\r\n  - 封装讯飞实时 ASR WebSocket API\r\n  - 支持流式音频输入\r\n  - Purpose: 提供语音识别能力\r\n  - _Leverage: 讯飞 ASR WebSocket API_\r\n  - _Requirements: REQ-6_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Speech Recognition Developer | Task: Create ASRClient with streaming WebSocket connection to XunFei ASR API for real-time transcription | Restrictions: Handle audio format requirements, implement VAD, return incremental results | _Leverage: XunFei ASR API docs | Success: Audio stream transcribes to text, handles continuous speech, returns partial results | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 7.3 实现 Tripo AI 3D 生成客户端\r\n  - Files: `AICityBack/ai/scene3d/__init__.py`, `AICityBack/ai/scene3d/tripo.py`\r\n  - 封装 Tripo AI API 调用\r\n  - 实现任务创建、状态查询、模型下载\r\n  - Purpose: 提供 3D 模型生成能力\r\n  - _Leverage: Tripo AI REST API_\r\n  - _Requirements: REQ-5_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: 3D/Graphics Developer | Task: Create TripoClient with methods to create generation task, poll status, download GLB model from Tripo AI API | Restrictions: Handle API rate limits, implement polling with backoff, validate model format | _Leverage: Tripo AI API docs, app/core/config.py | Success: Text/image generates 3D task, status polling works, GLB downloads correctly | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 7.4 创建语音和场景 API 路由\r\n  - Files: `AICityBack/app/api/v1/voice.py`, `AICityBack/app/api/v1/scene.py`\r\n  - 实现 TTS/ASR 流式端点\r\n  - 实现 3D 生成任务管理端点\r\n  - Purpose: 暴露语音和 3D 服务 API\r\n  - _Leverage: ai/voice/, ai/scene3d/, app/services/_\r\n  - _Requirements: REQ-5, REQ-6_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer | Task: Create voice API for TTS/ASR streaming and scene API for 3D generation task management | Restrictions: Use StreamingResponse for audio, proper content types, async task handling | _Leverage: ai/voice/, ai/scene3d/ | Success: TTS streams audio, ASR accepts audio stream, 3D tasks create and track properly | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 8: 异步任务和采集\r\n\r\n- [ ] 8.1 配置 Celery 和 Redis\r\n  - Files: `AICityBack/tasks/__init__.py`, `AICityBack/tasks/celery_app.py`\r\n  - 初始化 Celery 应用，配置 Redis broker\r\n  - Purpose: 建立异步任务基础设施\r\n  - _Leverage: Celery, Redis_\r\n  - _Requirements: REQ-8_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: DevOps Engineer with Celery expertise | Task: Initialize Celery application with Redis broker, configure task serialization and result backend | Restrictions: Use JSON serialization, configure retry policies, set up task routes | _Leverage: app/core/config.py | Success: Celery worker starts, tasks execute and return results via Redis | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 8.2 实现采集和分析异步任务\r\n  - Files: `AICityBack/tasks/crawler_tasks.py`, `AICityBack/tasks/analysis_tasks.py`\r\n  - 实现数据采集任务、批量分析任务\r\n  - Purpose: 异步执行耗时操作\r\n  - _Leverage: tasks/celery_app.py, app/services/_\r\n  - _Requirements: REQ-3, REQ-8_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with async task expertise | Task: Create Celery tasks for data crawling and batch AI analysis with progress tracking | Restrictions: Handle task failures, implement retry, emit WebSocket progress updates | _Leverage: tasks/celery_app.py, app/services/ai_service.py | Success: Tasks execute async, progress updates emit via WebSocket, failures retry | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 8.3 创建采集管理 API\r\n  - Files: `AICityBack/app/api/v1/crawler.py`, `AICityBack/app/services/crawler_service.py`\r\n  - 实现采集任务 CRUD 和状态管理\r\n  - Purpose: 管理数据采集任务\r\n  - _Leverage: tasks/crawler_tasks.py_\r\n  - _Requirements: REQ-8_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Developer | Task: Create crawler API for task CRUD, status query, pause/resume operations with CrawlerService | Restrictions: Admin only access, validate task configurations, handle task state transitions | _Leverage: tasks/crawler_tasks.py | Success: Tasks create/pause/resume, status queries work, admin authorization enforced | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n## Phase 9: 路由汇总和测试\r\n\r\n- [ ] 9.1 汇总所有 API 路由\r\n  - Files: `AICityBack/app/api/v1/__init__.py`, `AICityBack/app/api/router.py`\r\n  - 注册所有路由到主应用\r\n  - 配置路由前缀和标签\r\n  - Purpose: 完成 API 路由组织\r\n  - _Leverage: 所有 app/api/v1/*.py 路由_\r\n  - _Requirements: All_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Architect | Task: Create API router aggregating all v1 routes with proper prefixes, tags, and include in main app | Restrictions: Organize by domain, consistent naming, proper OpenAPI tags | _Leverage: All app/api/v1/*.py files | Success: All routes accessible under /api/v1, OpenAPI docs show organized endpoints | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 9.2 编写核心模块单元测试\r\n  - Files: `AICityBack/tests/test_auth.py`, `AICityBack/tests/test_sentiment.py`\r\n  - 测试认证和舆情核心功能\r\n  - Purpose: 确保核心功能正确性\r\n  - _Leverage: pytest, pytest-asyncio_\r\n  - _Requirements: REQ-1, REQ-2_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Write unit tests for auth service and sentiment service with proper mocking and fixtures | Restrictions: Use pytest-asyncio, mock external services, test success and failure cases | _Leverage: pytest, app/services/ | Success: Tests pass, cover auth flow and CRUD operations, good coverage | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 9.3 编写 API 集成测试\r\n  - Files: `AICityBack/tests/test_api.py`, `AICityBack/tests/conftest.py`\r\n  - 测试完整 API 流程\r\n  - Purpose: 验证 API 端到端功能\r\n  - _Leverage: httpx AsyncClient, pytest_\r\n  - _Requirements: All_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Write API integration tests using httpx AsyncClient with test database and fixtures | Restrictions: Isolate tests, clean up data, test auth flows end-to-end | _Leverage: pytest, httpx, app/main.py | Success: Integration tests pass, cover main user journeys, database cleaned between tests | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n\r\n- [ ] 9.4 创建 Docker 配置\r\n  - Files: `AICityBack/Dockerfile`, `AICityBack/docker-compose.yml`\r\n  - 配置应用容器化部署\r\n  - 包含 PostgreSQL、Redis、Celery worker\r\n  - Purpose: 支持容器化部署\r\n  - _Leverage: Docker, docker-compose_\r\n  - _Requirements: All_\r\n  - _Prompt: Implement the task for spec backend-api, first run spec-workflow-guide to get the workflow guide then implement the task: Role: DevOps Engineer | Task: Create Dockerfile for FastAPI app and docker-compose.yml with PostgreSQL, Redis, Celery worker services | Restrictions: Multi-stage build, non-root user, health checks, proper networking | _Leverage: requirements.txt | Success: docker-compose up starts all services, app connects to database and Redis | Instructions: First mark this task as in-progress [-] in tasks.md, implement the code, then use log-implementation tool to record details, finally mark as complete [x]_\r\n",
  "fileStats": {
    "size": 34720,
    "lines": 318,
    "lastModified": "2025-12-14T09:45:20.934Z"
  },
  "comments": []
}