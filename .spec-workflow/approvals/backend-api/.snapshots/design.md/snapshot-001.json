{
  "id": "snapshot_1765705541050_lisv8vtzr",
  "approvalId": "approval_1765705540964_jduthpe8l",
  "approvalTitle": "Backend API Design - 后端设计文档",
  "version": 1,
  "timestamp": "2025-12-14T09:45:41.049Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Backend API\r\n\r\n## Overview\r\n\r\n本文档描述 **智舆** 后端 API 服务的技术设计。后端采用 FastAPI + Python 构建，遵循分层架构模式，集成讯飞 AI 服务、LangGraph 多 Agent 决策、Celery 异步任务等核心能力。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n\r\n- **框架**: FastAPI 0.109+ (异步支持、自动文档)\r\n- **ORM**: SQLAlchemy 2.0 (异步)\r\n- **验证**: Pydantic 2.6\r\n- **任务队列**: Celery 5.3 + Redis\r\n- **WebSocket**: python-socketio 5.11\r\n- **AI 集成**: 讯飞星火 4.0、LangGraph、讯飞 TTS/ASR\r\n\r\n### Project Structure (structure.md)\r\n\r\n遵循 `AICityBack/` 目录结构：\r\n- `app/api/v1/` - API 路由\r\n- `app/services/` - 业务服务\r\n- `app/models/` - 数据模型\r\n- `app/schemas/` - Pydantic 模式\r\n- `agents/` - LangGraph Agent\r\n- `ai/` - AI 能力封装\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n\r\n- **前端 WebSocket 服务**: `AICityFornt/src/services/websocket.js` 已实现 Socket.io 客户端，后端需兼容\r\n- **前端 API 模式**: 参考 `AICityFornt/src/api/` 的接口设计保持一致性\r\n- **模拟数据结构**: 参考前端 mock 数据的字段定义\r\n\r\n### Integration Points\r\n\r\n- **高德地图**: 坐标数据格式 `[lng, lat]`\r\n- **前端状态管理**: Pinia store 结构对应 API 响应格式\r\n- **ECharts**: 图表数据格式需与前端兼容\r\n\r\n## Architecture\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph Client[\"前端 (Vue3)\"]\r\n        FE[Frontend]\r\n    end\r\n    \r\n    subgraph API[\"API Layer\"]\r\n        Router[FastAPI Router]\r\n        WS[WebSocket Manager]\r\n    end\r\n    \r\n    subgraph Service[\"Service Layer\"]\r\n        AuthSvc[Auth Service]\r\n        SentimentSvc[Sentiment Service]\r\n        AISvc[AI Service]\r\n        DecisionSvc[Decision Service]\r\n        SceneSvc[Scene Service]\r\n        VoiceSvc[Voice Service]\r\n        CrawlerSvc[Crawler Service]\r\n    end\r\n    \r\n    subgraph AI[\"AI Layer\"]\r\n        Spark[讯飞星火]\r\n        TTS[讯飞 TTS]\r\n        ASR[讯飞 ASR]\r\n        Tripo[Tripo AI]\r\n        LangGraph[LangGraph Agents]\r\n    end\r\n    \r\n    subgraph Data[\"Data Layer\"]\r\n        PG[(PostgreSQL)]\r\n        Redis[(Redis)]\r\n        MinIO[(MinIO)]\r\n        ES[(Elasticsearch)]\r\n    end\r\n    \r\n    subgraph Task[\"Task Layer\"]\r\n        Celery[Celery Workers]\r\n        Scheduler[APScheduler]\r\n    end\r\n    \r\n    FE --> Router\r\n    FE <--> WS\r\n    \r\n    Router --> AuthSvc\r\n    Router --> SentimentSvc\r\n    Router --> AISvc\r\n    Router --> DecisionSvc\r\n    Router --> SceneSvc\r\n    Router --> VoiceSvc\r\n    Router --> CrawlerSvc\r\n    \r\n    AISvc --> Spark\r\n    VoiceSvc --> TTS\r\n    VoiceSvc --> ASR\r\n    SceneSvc --> Tripo\r\n    DecisionSvc --> LangGraph\r\n    \r\n    SentimentSvc --> PG\r\n    SentimentSvc --> ES\r\n    AuthSvc --> PG\r\n    AuthSvc --> Redis\r\n    SceneSvc --> MinIO\r\n    \r\n    CrawlerSvc --> Celery\r\n    Scheduler --> Celery\r\n    Celery --> PG\r\n    \r\n    WS --> Redis\r\n```\r\n\r\n### Modular Design Principles\r\n\r\n- **Single File Responsibility**: 每个 API 路由文件对应一个业务域\r\n- **Component Isolation**: 服务层独立，可单独测试和替换\r\n- **Service Layer Separation**: API -> Service -> Repository 三层分离\r\n- **Utility Modularity**: AI 客户端、工具函数独立封装\r\n\r\n## Components and Interfaces\r\n\r\n### Component 1: FastAPI Application Core\r\n\r\n- **Purpose:** 应用入口，路由注册，中间件配置\r\n- **File:** `app/main.py`\r\n- **Interfaces:**\r\n  ```python\r\n  app = FastAPI(title=\"智舆 API\", version=\"1.0.0\")\r\n  app.include_router(api_router, prefix=\"/api/v1\")\r\n  sio = socketio.AsyncServer(async_mode='asgi', cors_allowed_origins='*')\r\n  ```\r\n- **Dependencies:** FastAPI, python-socketio, uvicorn\r\n\r\n### Component 2: Authentication Service\r\n\r\n- **Purpose:** 用户认证、JWT 管理\r\n- **File:** `app/services/auth_service.py`\r\n- **Interfaces:**\r\n  ```python\r\n  class AuthService:\r\n      async def authenticate(username: str, password: str) -> TokenPair\r\n      async def verify_token(token: str) -> User\r\n      async def refresh_token(refresh_token: str) -> TokenPair\r\n      async def get_current_user(token: str) -> User\r\n  ```\r\n- **Dependencies:** `app/core/security.py`, `app/models/user.py`\r\n\r\n### Component 3: Sentiment Service\r\n\r\n- **Purpose:** 舆情数据 CRUD、统计分析\r\n- **File:** `app/services/sentiment_service.py`\r\n- **Interfaces:**\r\n  ```python\r\n  class SentimentService:\r\n      async def get_hotspots(filters: HotspotFilter, pagination: Pagination) -> List[Hotspot]\r\n      async def get_hotspot(id: int) -> Hotspot\r\n      async def create_hotspot(data: HotspotCreate) -> Hotspot\r\n      async def update_hotspot(id: int, data: HotspotUpdate) -> Hotspot\r\n      async def delete_hotspot(id: int) -> bool\r\n      async def get_statistics(city: str, time_range: TimeRange) -> Statistics\r\n  ```\r\n- **Dependencies:** `app/models/sentiment.py`, `app/db/session.py`\r\n\r\n### Component 4: AI Analysis Service\r\n\r\n- **Purpose:** 封装讯飞星火 API 调用\r\n- **File:** `app/services/ai_service.py`, `ai/spark/client.py`\r\n- **Interfaces:**\r\n  ```python\r\n  class AIService:\r\n      async def analyze_sentiment(content: str) -> AnalysisResult\r\n      async def extract_keywords(content: str) -> List[str]\r\n      async def generate_summary(content: str) -> str\r\n      async def batch_analyze(contents: List[str]) -> List[AnalysisResult]\r\n  \r\n  class SparkClient:\r\n      async def chat(messages: List[Message]) -> str\r\n      async def chat_stream(messages: List[Message]) -> AsyncGenerator[str]\r\n  ```\r\n- **Dependencies:** `ai/spark/config.py`, httpx/websockets\r\n\r\n### Component 5: Decision Service\r\n\r\n- **Purpose:** LangGraph 多 Agent 决策模拟\r\n- **File:** `app/services/decision_service.py`, `agents/graph.py`\r\n- **Interfaces:**\r\n  ```python\r\n  class DecisionService:\r\n      async def predict_trend(hotspot_id: int, hours: int) -> TrendPrediction\r\n      async def simulate_decision(scenario: Scenario) -> SimulationResult\r\n      async def custom_simulate(params: CustomParams) -> SimulationResult\r\n  \r\n  # LangGraph State\r\n  class SentimentState(TypedDict):\r\n      input: str\r\n      analysis: dict\r\n      predictions: list\r\n      decisions: list\r\n      simulation: dict\r\n  ```\r\n- **Dependencies:** `agents/nodes/`, langgraph, `ai/spark/client.py`\r\n\r\n### Component 6: Scene Service\r\n\r\n- **Purpose:** 3D 场景生成管理\r\n- **File:** `app/services/scene_service.py`, `ai/scene3d/tripo.py`\r\n- **Interfaces:**\r\n  ```python\r\n  class SceneService:\r\n      async def generate_from_text(description: str) -> GenerationTask\r\n      async def generate_from_image(image_url: str) -> GenerationTask\r\n      async def get_task_status(task_id: str) -> TaskStatus\r\n      async def get_model_url(task_id: str) -> str\r\n  \r\n  class TripoClient:\r\n      async def create_task(prompt: str, image: Optional[bytes]) -> str\r\n      async def poll_status(task_id: str) -> TaskStatus\r\n      async def download_model(task_id: str) -> bytes\r\n  ```\r\n- **Dependencies:** `ai/scene3d/tripo.py`, MinIO client\r\n\r\n### Component 7: Voice Service\r\n\r\n- **Purpose:** 语音合成与识别\r\n- **File:** `app/services/voice_service.py`, `ai/voice/`\r\n- **Interfaces:**\r\n  ```python\r\n  class VoiceService:\r\n      async def text_to_speech(text: str, voice_id: str) -> AsyncGenerator[bytes]\r\n      async def speech_to_text(audio_stream: AsyncGenerator[bytes]) -> str\r\n      async def transcribe_long_audio(audio_url: str) -> str\r\n  ```\r\n- **Dependencies:** `ai/voice/tts.py`, `ai/voice/asr.py`, websockets\r\n\r\n### Component 8: WebSocket Manager\r\n\r\n- **Purpose:** 实时通信连接管理\r\n- **File:** `app/websocket/manager.py`, `app/websocket/events.py`\r\n- **Interfaces:**\r\n  ```python\r\n  class WebSocketManager:\r\n      async def connect(sid: str, user_id: int)\r\n      async def disconnect(sid: str)\r\n      async def join_room(sid: str, room: str)\r\n      async def leave_room(sid: str, room: str)\r\n      async def emit(event: str, data: dict, room: Optional[str])\r\n      async def broadcast(event: str, data: dict)\r\n  ```\r\n- **Dependencies:** python-socketio, Redis (pub/sub)\r\n\r\n### Component 9: Crawler Service\r\n\r\n- **Purpose:** 数据采集任务管理\r\n- **File:** `app/services/crawler_service.py`, `tasks/crawler_tasks.py`\r\n- **Interfaces:**\r\n  ```python\r\n  class CrawlerService:\r\n      async def create_task(config: CrawlerConfig) -> CrawlerTask\r\n      async def get_task_status(task_id: str) -> TaskStatus\r\n      async def pause_task(task_id: str) -> bool\r\n      async def resume_task(task_id: str) -> bool\r\n      async def delete_task(task_id: str) -> bool\r\n  ```\r\n- **Dependencies:** Celery, `crawler/spiders/`\r\n\r\n## Data Models\r\n\r\n### User Model\r\n```python\r\nclass User(Base):\r\n    __tablename__ = \"users\"\r\n    \r\n    id: int                      # Primary Key\r\n    username: str                # Unique, indexed\r\n    email: str                   # Unique\r\n    hashed_password: str\r\n    role: str                    # admin, analyst, viewer\r\n    is_active: bool              # Default True\r\n    created_at: datetime\r\n    updated_at: datetime\r\n```\r\n\r\n### Sentiment/Hotspot Model\r\n```python\r\nclass Hotspot(Base):\r\n    __tablename__ = \"hotspots\"\r\n    \r\n    id: int                      # Primary Key\r\n    title: str                   # 标题\r\n    content: str                 # 内容\r\n    source: str                  # 来源平台\r\n    source_url: str              # 原始链接\r\n    media_type: str              # text, image, video\r\n    media_urls: List[str]        # JSON Array\r\n    city: str                    # 城市\r\n    district: str                # 区县\r\n    location: dict               # {lng, lat}\r\n    heat: int                    # 热度值\r\n    sentiment: str               # positive, neutral, negative\r\n    sentiment_score: float       # -1.0 ~ 1.0\r\n    keywords: List[str]          # JSON Array\r\n    summary: str                 # AI 摘要\r\n    status: str                  # active, archived, deleted\r\n    published_at: datetime       # 发布时间\r\n    created_at: datetime\r\n    updated_at: datetime\r\n```\r\n\r\n### Analysis Result Model\r\n```python\r\nclass AnalysisResult(Base):\r\n    __tablename__ = \"analysis_results\"\r\n    \r\n    id: int\r\n    hotspot_id: int              # Foreign Key\r\n    analysis_type: str           # sentiment, prediction, decision\r\n    result: dict                 # JSON - 分析结果\r\n    model_version: str           # AI 模型版本\r\n    processing_time: float       # 处理耗时 (ms)\r\n    created_at: datetime\r\n```\r\n\r\n### Scene Generation Task Model\r\n```python\r\nclass SceneTask(Base):\r\n    __tablename__ = \"scene_tasks\"\r\n    \r\n    id: int\r\n    hotspot_id: int              # Foreign Key (optional)\r\n    input_type: str              # text, image\r\n    input_content: str           # 输入内容/URL\r\n    status: str                  # pending, processing, completed, failed\r\n    progress: int                # 0-100\r\n    model_url: str               # MinIO 存储路径\r\n    error_message: str           # 错误信息\r\n    created_at: datetime\r\n    completed_at: datetime\r\n```\r\n\r\n### Crawler Task Model\r\n```python\r\nclass CrawlerTask(Base):\r\n    __tablename__ = \"crawler_tasks\"\r\n    \r\n    id: int\r\n    name: str                    # 任务名称\r\n    source: str                  # weibo, xiaohongshu, douyin...\r\n    keywords: List[str]          # 监控关键词\r\n    schedule: str                # cron 表达式\r\n    is_active: bool\r\n    last_run_at: datetime\r\n    next_run_at: datetime\r\n    total_collected: int         # 累计采集数\r\n    created_at: datetime\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n1. **认证失败 (401)**\r\n   - **Handling:** 返回 `{\"detail\": \"Invalid credentials\", \"code\": \"AUTH_FAILED\"}`\r\n   - **User Impact:** 前端跳转登录页\r\n\r\n2. **权限不足 (403)**\r\n   - **Handling:** 返回 `{\"detail\": \"Permission denied\", \"code\": \"FORBIDDEN\"}`\r\n   - **User Impact:** 提示无权限操作\r\n\r\n3. **资源不存在 (404)**\r\n   - **Handling:** 返回 `{\"detail\": \"Hotspot not found\", \"code\": \"NOT_FOUND\"}`\r\n   - **User Impact:** 显示资源不存在提示\r\n\r\n4. **验证失败 (422)**\r\n   - **Handling:** 返回 Pydantic 验证错误详情\r\n   - **User Impact:** 显示具体字段错误\r\n\r\n5. **AI 服务不可用 (503)**\r\n   - **Handling:** 返回 `{\"detail\": \"AI service unavailable\", \"code\": \"SERVICE_UNAVAILABLE\"}`，记录日志，触发告警\r\n   - **User Impact:** 显示降级提示，使用缓存数据\r\n\r\n6. **速率限制 (429)**\r\n   - **Handling:** 返回 `{\"detail\": \"Too many requests\", \"retry_after\": 60}`\r\n   - **User Impact:** 显示稍后重试提示\r\n\r\n### 统一错误响应格式\r\n\r\n```python\r\nclass ErrorResponse(BaseModel):\r\n    detail: str                  # 错误描述\r\n    code: str                    # 错误代码\r\n    timestamp: datetime          # 时间戳\r\n    path: str                    # 请求路径\r\n    request_id: str              # 请求追踪 ID\r\n```\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n- **框架**: pytest + pytest-asyncio\r\n- **覆盖目标**: \r\n  - Services: 90%+\r\n  - Models: 85%+\r\n  - Utils: 95%+\r\n- **Mock**: 使用 `unittest.mock` 模拟外部服务\r\n\r\n### Integration Testing\r\n\r\n- **数据库**: 使用 SQLite 内存数据库或 TestContainers\r\n- **Redis**: 使用 fakeredis\r\n- **关键流程**:\r\n  - 认证流程完整测试\r\n  - 舆情 CRUD 完整测试\r\n  - WebSocket 连接测试\r\n\r\n### End-to-End Testing\r\n\r\n- **工具**: pytest + httpx AsyncClient\r\n- **场景**:\r\n  - 用户登录 -> 获取舆情 -> AI 分析 -> 决策模拟\r\n  - WebSocket 连接 -> 接收实时推送\r\n  - 采集任务创建 -> 数据入库 -> 触发分析\r\n",
  "fileStats": {
    "size": 13614,
    "lines": 425,
    "lastModified": "2025-12-14T09:43:09.394Z"
  },
  "comments": []
}