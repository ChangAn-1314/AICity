{
  "id": "snapshot_1764769119040_49y1u14i5",
  "approvalId": "approval_1764769119015_tssbq9x13",
  "approvalTitle": "Design - AI City 前端设计文档",
  "version": 1,
  "timestamp": "2025-12-03T13:38:39.040Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - AI City 前端系统\r\n\r\n## Overview\r\n\r\nAI City 前端采用 Vue 3 组合式 API + Vite 构建，以高德地图 3D 为核心可视化引擎，结合 Element Plus UI 组件库和 TailwindCSS 样式框架，实现舆情态势的 3D 可视化展示和交互。\r\n\r\n系统采用分层架构：视图层 (Vue Components) -> 状态层 (Pinia Stores) -> 服务层 (API Services) -> 外部接口层 (高德地图/WebSocket/后端 API)。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n\r\n- **前端框架**: Vue 3.5 + Vite 6.0，符合 tech.md 规定\r\n- **UI 组件**: Element Plus + TailwindCSS，统一深色科技感风格\r\n- **3D 引擎**: 高德 JS API 2.0 (viewMode: '3D')，Three.js 加载 GLB 模型\r\n- **状态管理**: Pinia，按功能模块划分 Store\r\n- **实时通信**: Socket.io-client，用于舆情推送\r\n\r\n### Project Structure (structure.md)\r\n\r\n遵循 structure.md 定义的目录结构：\r\n\r\n- `components/features/` - 按功能模块组织 (Map/Monitor/Analysis/Simulation)\r\n- `components/layout/` - 布局组件 (AppShell/DynamicIsland)\r\n- `components/ui/` - 通用 UI 组件 (GlassPanel/NeonButton)\r\n- `stores/` - Pinia 状态模块\r\n- `api/` - API 服务封装\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n\r\n| 组件                   | 位置                 | 复用方式                   |\r\n| ---------------------- | -------------------- | -------------------------- |\r\n| **CityMap3D-AMap.vue** | features/Map/        | 扩展舆情热点显示和下钻功能 |\r\n| **NewsTicker.vue**     | features/Monitor/    | 扩展实时数据接入和定位联动 |\r\n| **InsightCard.vue**    | features/Analysis/   | 扩展 AI 分析结果展示       |\r\n| **DecisionPanel.vue**  | features/Simulation/ | 扩展方案选择和模拟交互     |\r\n| **GlassPanel.vue**     | ui/                  | 直接复用，作为面板容器     |\r\n| **AppShell.vue**       | layout/              | 扩展路由和状态管理         |\r\n\r\n### Integration Points\r\n\r\n| 集成点          | 现状                       | 扩展计划                         |\r\n| --------------- | -------------------------- | -------------------------------- |\r\n| **高德地图**    | 已集成基础 3D 地图         | 添加舆情标记层、区域边界、热力图 |\r\n| **Pinia Store** | stores/index.js 存在但为空 | 创建舆情/地图/分析等模块化 Store |\r\n| **WebSocket**   | socket.io-client 已安装    | 创建 WebSocket 服务封装          |\r\n\r\n## Architecture\r\n\r\n### 系统架构图\r\n\r\n```mermaid\r\ngraph TD\r\n    subgraph 视图层\r\n        AppShell[AppShell.vue]\r\n        Map[CityMap3D-AMap.vue]\r\n        Monitor[NewsTicker.vue]\r\n        Analysis[InsightCard.vue]\r\n        Simulation[DecisionPanel.vue]\r\n    end\r\n\r\n    subgraph 状态层\r\n        MapStore[mapStore]\r\n        OpinionStore[opinionStore]\r\n        AnalysisStore[analysisStore]\r\n        SimulationStore[simulationStore]\r\n    end\r\n\r\n    subgraph 服务层\r\n        MapService[mapService.js]\r\n        OpinionService[opinionService.js]\r\n        WebSocketService[wsService.js]\r\n        AIService[aiService.js]\r\n    end\r\n\r\n    subgraph 外部接口\r\n        AMap[高德地图 API]\r\n        Backend[后端 API]\r\n        WS[WebSocket Server]\r\n    end\r\n\r\n    AppShell --> Map\r\n    AppShell --> Monitor\r\n    AppShell --> Analysis\r\n    AppShell --> Simulation\r\n\r\n    Map --> MapStore\r\n    Monitor --> OpinionStore\r\n    Analysis --> AnalysisStore\r\n    Simulation --> SimulationStore\r\n\r\n    MapStore --> MapService\r\n    OpinionStore --> OpinionService\r\n    OpinionStore --> WebSocketService\r\n    AnalysisStore --> AIService\r\n    SimulationStore --> AIService\r\n\r\n    MapService --> AMap\r\n    OpinionService --> Backend\r\n    WebSocketService --> WS\r\n    AIService --> Backend\r\n```\r\n\r\n### Modular Design Principles\r\n\r\n- **Single File Responsibility**: 每个 Vue 组件 < 300 行，超出则拆分\r\n- **Component Isolation**: 组件通过 Props/Emits 通信，不直接访问其他组件状态\r\n- **Service Layer Separation**: API 调用封装在 services/，不在组件中直接调用\r\n- **Utility Modularity**: 工具函数按功能分文件 (mapUtils.js, formatUtils.js)\r\n\r\n## Components and Interfaces\r\n\r\n### CityMap3D-AMap.vue (扩展)\r\n\r\n- **Purpose**: 3D 地图主组件，展示舆情空间分布\r\n- **Interfaces**:\r\n  - Props: `center: [lng, lat]`, `zoom: number`, `opinions: Opinion[]`\r\n  - Emits: `@opinion-click`, `@region-click`, `@map-ready`\r\n- **Dependencies**: 高德地图 API, mapStore, Three.js\r\n- **Reuses**: 现有地图初始化逻辑\r\n\r\n### OpinionMarkerLayer.vue (新建)\r\n\r\n- **Purpose**: 舆情标记图层，管理地图上的舆情点\r\n- **Interfaces**:\r\n  - Props: `opinions: Opinion[]`, `selectedId: string`\r\n  - Emits: `@marker-click`\r\n- **Dependencies**: AMap.Marker, opinionStore\r\n\r\n### RegionHeatLayer.vue (新建)\r\n\r\n- **Purpose**: 区域热力图层，显示舆情热度分布\r\n- **Interfaces**:\r\n  - Props: `heatData: HeatPoint[]`, `visible: boolean`\r\n  - Emits: `@region-click`\r\n- **Dependencies**: AMap.Heatmap\r\n\r\n### NewsTicker.vue (扩展)\r\n\r\n- **Purpose**: 实时舆情滚动列表\r\n- **Interfaces**:\r\n  - Props: `maxItems: number`\r\n  - Emits: `@item-click`\r\n- **Dependencies**: opinionStore, wsService\r\n- **Reuses**: 现有滚动动画逻辑\r\n\r\n### TrendChart.vue (新建)\r\n\r\n- **Purpose**: 舆情趋势图表组件\r\n- **Interfaces**:\r\n  - Props: `data: TrendData[]`, `timeRange: string`\r\n- **Dependencies**: ECharts, analysisStore\r\n\r\n### DecisionPanel.vue (扩展)\r\n\r\n- **Purpose**: 决策模拟面板\r\n- **Interfaces**:\r\n  - Props: `scenarios: Scenario[]`\r\n  - Emits: `@simulate`, `@apply`\r\n- **Dependencies**: simulationStore, aiService\r\n- **Reuses**: 现有面板布局\r\n\r\n## Data Models\r\n\r\n### Opinion (舆情数据)\r\n\r\n```typescript\r\ninterface Opinion {\r\n  id: string; // 舆情唯一标识\r\n  title: string; // 舆情标题\r\n  content: string; // 舆情内容摘要\r\n  source: \"weibo\" | \"douyin\" | \"news\" | \"forum\"; // 来源平台\r\n  type: \"text\" | \"image\" | \"video\"; // 内容类型\r\n  sentiment: \"positive\" | \"neutral\" | \"negative\"; // 情感倾向\r\n  level: \"low\" | \"medium\" | \"high\" | \"critical\"; // 舆情等级\r\n  location: {\r\n    lng: number; // 经度\r\n    lat: number; // 纬度\r\n    region: string; // 区域名称\r\n  };\r\n  keywords: string[]; // 关键词\r\n  createdAt: string; // 发布时间\r\n  analyzedAt: string; // 分析时间\r\n}\r\n```\r\n\r\n### AnalysisResult (分析结果)\r\n\r\n```typescript\r\ninterface AnalysisResult {\r\n  opinionId: string; // 关联舆情 ID\r\n  summary: string; // AI 摘要\r\n  sentiment: {\r\n    label: string; // 情感标签\r\n    score: number; // 置信度 0-1\r\n  };\r\n  keywords: Array<{\r\n    word: string;\r\n    weight: number;\r\n  }>;\r\n  trend: \"rising\" | \"stable\" | \"declining\"; // 趋势\r\n  riskLevel: number; // 风险评分 0-100\r\n  suggestions: string[]; // AI 建议\r\n}\r\n```\r\n\r\n### Scenario (决策方案)\r\n\r\n```typescript\r\ninterface Scenario {\r\n  id: string; // 方案 ID\r\n  name: string; // 方案名称\r\n  description: string; // 方案描述\r\n  actions: string[]; // 具体措施\r\n  predictedEffect: {\r\n    sentiment: number; // 预测情感变化 -1 到 1\r\n    spread: number; // 预测传播变化 -1 到 1\r\n    duration: number; // 预测持续时间 (小时)\r\n  };\r\n  confidence: number; // 置信度 0-1\r\n}\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n1. **地图加载失败**\r\n\r\n   - **Handling**: 重试 3 次，失败后显示 2D 静态地图降级方案\r\n   - **User Impact**: 提示\"地图加载中...\"，降级后提示\"已切换为简化视图\"\r\n\r\n2. **WebSocket 断连**\r\n\r\n   - **Handling**: 自动重连 (指数退避)，断连期间显示\"连接中\"状态\r\n   - **User Impact**: 顶部状态栏显示连接状态，恢复后自动同步缺失数据\r\n\r\n3. **API 请求失败**\r\n\r\n   - **Handling**: 显示 Toast 错误提示，保留上次成功数据\r\n   - **User Impact**: 非阻塞式提示，不影响其他功能使用\r\n\r\n4. **舆情数据为空**\r\n   - **Handling**: 显示空状态占位符\r\n   - **User Impact**: 友好提示\"暂无舆情数据\"\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n- **框架**: Vitest\r\n- **覆盖目标**:\r\n  - Pinia Stores: 100% 覆盖\r\n  - 工具函数: 100% 覆盖\r\n  - 组件逻辑: 80% 覆盖\r\n\r\n### Integration Testing\r\n\r\n- **框架**: Vue Test Utils + Vitest\r\n- **重点场景**:\r\n  - Store 与组件交互\r\n  - API 服务调用\r\n  - WebSocket 事件处理\r\n\r\n### End-to-End Testing\r\n\r\n- **框架**: Playwright (待配置)\r\n- **关键用户路径**:\r\n  - 地图加载 -> 查看舆情标记 -> 点击查看详情\r\n  - 实时舆情推送 -> 列表更新 -> 地图联动\r\n  - 选择决策方案 -> 查看模拟结果\r\n",
  "fileStats": {
    "size": 8703,
    "lines": 274,
    "lastModified": "2025-12-03T13:38:21.714Z"
  },
  "comments": []
}